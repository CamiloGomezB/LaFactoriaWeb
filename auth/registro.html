<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro</title>
  <link rel="stylesheet" href="css/stylerl.css">
  <style>
    #codigoContainer, #camposVendedor, #errorMensaje {
      display: none;
    }
    #errorMensaje {
      color: red;
      margin-top: 10px;
    }
  </style>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
  import { guardarVendedorEnFirestore } from "js/registro2.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAscPqbFzJxZiXYo-2FCcOynMv6HJfJmaE",
    authDomain: "weblafactor.firebaseapp.com",
    projectId: "weblafactor",
    storageBucket: "weblafactor.appspot.com",
    appId: "1:690032474707:web:e948852878cc6b6c8ee4a6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const CODIGO_ADMIN = "CODIGOADMIN123456789012345";
  const CODIGO_VENDEDOR = "CODIGOVENDEDOR123456789012";

  window.addEventListener("DOMContentLoaded", () => {
    const rolSelect = document.getElementById("rol");
    const codigoContainer = document.getElementById("codigoContainer");
    const camposVendedor = document.getElementById("camposVendedor");
    const errorMensaje = document.getElementById("errorMensaje");

    rolSelect.addEventListener("change", () => {
      const rol = rolSelect.value;

      if (rol === "admin" || rol === "vendedor") {
        codigoContainer.style.display = "block";
        document.getElementById("codigo").required = true;
      } else {
        codigoContainer.style.display = "none";
        document.getElementById("codigo").required = false;
      }

      if (rol === "vendedor") {
        camposVendedor.style.display = "block";
        document.getElementById("telefono").required = true;
        document.getElementById("ocupacion").required = true;
        document.getElementById("foto").required = true;
      } else {
        camposVendedor.style.display = "none";
        document.getElementById("telefono").required = false;
        document.getElementById("ocupacion").required = false;
        document.getElementById("foto").required = false;
      }
    });

    document.getElementById("registroForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMensaje.style.display = "none";

      const nombre = document.getElementById("nombre").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const rol = document.getElementById("rol").value;
      const codigoIngresado = document.getElementById("codigo").value;

      const telefono = document.getElementById("telefono").value;
      const ocupacion = document.getElementById("ocupacion").value;
      const fotoFile = document.getElementById("foto").files[0];

      if (rol === "admin" && codigoIngresado !== CODIGO_ADMIN) {
        errorMensaje.textContent = "Código incorrecto para Administrador.";
        errorMensaje.style.display = "block";
        return;
      }

      if (rol === "vendedor" && codigoIngresado !== CODIGO_VENDEDOR) {
        errorMensaje.textContent = "Código incorrecto para Vendedor.";
        errorMensaje.style.display = "block";
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: nombre });

        // Guardar adicionalmente en colección 'usuarios' si deseas
        await setDoc(doc(db, "usuarios", email), {
          nombre,
          email,
          rol
        });

        // Guardar vendedor en colección 'vendedores' con imagen base64
        if (rol === "vendedor") {
          await guardarVendedorEnFirestore({
            nombre,
            email,
            rol,
            telefono,
            ocupacion,
            fotoFile
          });
        }

        alert("Usuario registrado correctamente.");
        window.location.href = "login.html";
      } catch (error) {
        errorMensaje.textContent = "Error: " + (error.code === 'auth/email-already-in-use'
          ? "Este correo ya está en uso. Por favor, usa otro."
          : error.message);
        errorMensaje.style.display = "block";
      }
    });
  });
</script>
  

</head>
<body>

  <form id="registroForm">
    <h2>Registro</h2>
    <input type="text" id="nombre" placeholder="Nombre" required>
    <input type="email" id="email" placeholder="Correo" required>
    <input type="password" id="password" placeholder="Contraseña" required>
    <select id="rol" required>
      <option value="">Seleccione un rol</option>
      <option value="usuario">Comprador</option>
      <option value="vendedor">Vendedor</option>
      <option value="admin">Administrador</option>
    </select>

    <div id="codigoContainer">
      <input type="password" id="codigo" placeholder="Código único">
    </div>

    <div id="camposVendedor">
      <input type="tel" id="telefono" placeholder="Número de teléfono">
      <input type="text" id="ocupacion" placeholder="Ocupación">
      <label for="foto">Foto de perfil:</label>
      <input type="file" id="foto" accept="image/*">
    </div>

    <button type="submit">Registrarse</button>
    <p id="errorMensaje"></p>
  </form>
</body>
</html>
